<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas - AI Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/static/atlasIcon.png">
    <link rel="apple-touch-icon" href="/static/atlasIcon.png">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Backend API Configuration -->
    <script src="config.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#fff1f2', 100: '#ffe4e6', 500: '#f43f5e', 600: '#e11d48', 900: '#881337' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* --- MODERN CARD DESIGNS --- */
        .exercise-card,
        .nutrition-card {
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dark .exercise-card,
        .dark .nutrition-card {
            background: #1e293b;
            border-color: #334155;
            color: #f8fafc;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
        }

        .exercise-card:hover,
        .nutrition-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -12px rgba(225, 29, 72, 0.15);
        }

        /* Card Header */
        .card-header {
            background: #fff;
            padding: 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark .card-header {
            background: #1e293b;
            border-color: #334155;
        }

        .card-title {
            font-weight: 800;
            font-size: 1.1rem;
            color: #1e293b;
            letter-spacing: -0.02em;
        }

        .dark .card-title {
            color: #f8fafc;
        }

        /* Badges */
        .difficulty-badge {
            background: #fff1f2;
            color: #be123c;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
        }

        .dark .difficulty-badge {
            background: #881337;
            color: #fff1f2;
        }

        /* Body & Content */
        .card-body {
            padding: 1.25rem;
        }

        .meta-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #64748b;
        }

        .dark .meta-row {
            color: #94a3b8;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
        }

        .meta-item i {
            color: #e11d48;
        }

        /* Protocol Box */
        .protocol-box {
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #334155;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dark .protocol-box {
            background: #0f172a;
            border-color: #475569;
            color: #e2e8f0;
        }

        /* Action Buttons */
        .action-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        .btn-secondary {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            background: #f1f5f9;
            color: #475569;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            font-weight: 700;
            transition: all 0.2s;
            text-decoration: none;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .dark .btn-secondary {
            background: #334155;
            color: #cbd5e1;
        }

        .dark .btn-secondary:hover {
            background: #475569;
            color: #fff;
        }

        .btn-primary {
            flex: 2;
            text-align: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            color: white;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            font-weight: 700;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
            text-decoration: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(225, 29, 72, 0.4);
        }

        /* Profile Stats Card Gradient */
        .stats-card-gradient {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
        }

        /* Visual Selectors */
        .visual-option,
        .visual-level,
        .visual-gender {
            border: 2px solid #f3f4f6;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dark .visual-option,
        .dark .visual-level,
        .dark .visual-gender {
            border-color: #374151;
        }

        .visual-option:hover,
        .visual-level:hover,
        .visual-gender:hover {
            border-color: #fecaca;
            background: #fff5f5;
        }

        .dark .visual-option:hover,
        .dark .visual-level:hover,
        .dark .visual-gender:hover {
            border-color: #991b1b;
            background: #374151;
        }

        .visual-option.selected,
        .visual-level.selected,
        .visual-gender.selected {
            border-color: #dc2626;
            background: #fef2f2;
            color: #991b1b;
        }

        .dark .visual-option.selected,
        .dark .visual-level.selected,
        .dark .visual-gender.selected {
            border-color: #f43f5e;
            background: #881337;
            color: #fff;
        }

        /* DESCRIPTION TOGGLE UPDATE */
        details.desc-toggle summary {
            list-style: none;
        }

        details.desc-toggle summary::-webkit-details-marker {
            display: none;
        }

        .group-open\/desc\:rotate-90 {
            transform: rotate(90deg);
        }

        .exercise-card,
        .nutrition-card {
            overflow: visible !important;
        }

        /* New Style for Text Area & Input */
        .modern-input {
            width: 100%;
            padding: 1rem;
            background-color: #f8fafc;
            border: 2px solid #f1f5f9;
            border-radius: 1rem;
            color: #334155;
            font-weight: 600;
            transition: all 0.2s;
            outline: none;
        }

        .dark .modern-input {
            background-color: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        .modern-input:focus {
            border-color: #e11d48;
            background-color: white;
        }

        .dark .modern-input:focus {
            background-color: #1e293b;
        }

        /* Message Input Specific */
        .chat-input-container {
            border: 2px solid #f1f5f9;
        }

        .dark .chat-input-container {
            border-color: #334155;
        }

        .chat-input-container:focus-within {
            border-color: #e11d48;
            box-shadow: 0 4px 20px rgba(225, 29, 72, 0.1);
        }
    </style>
</head>

<body
    class="bg-[#f8fafc] dark:bg-dark-900 h-screen flex overflow-hidden text-slate-800 dark:text-slate-100 transition-colors duration-300">

    <!-- SIDEBAR -->
    <aside id="sidebar"
        class="bg-white dark:bg-dark-800 border-r border-slate-200 dark:border-slate-700 h-full flex flex-col transition-all duration-300 w-80 z-40 absolute md:relative -translate-x-full md:translate-x-0 shadow-2xl md:shadow-none">

        <!-- Header -->
        <div class="h-20 flex items-center px-6 justify-between shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-xl flex items-center justify-center overflow-hidden shrink-0">
                    <img src="/static/atlasIcon.png" class="w-full h-full object-contain drop-shadow-lg">
                </div>
                <h1 class="font-extrabold text-xl tracking-tight text-slate-900 dark:text-white">Atlas<span
                        class="text-brand-600">.ai</span></h1>
            </div>
            <button onclick="toggleMobileSidebar()" class="md:hidden text-slate-400 hover:text-slate-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- NEW: USER STATS CARD -->
        <div class="px-5 mb-4">
            <div
                class="stats-card-gradient rounded-2xl p-5 text-white shadow-xl shadow-brand-500/20 relative overflow-hidden group">
                <!-- Background Deco -->
                <div
                    class="absolute top-0 right-0 w-24 h-24 bg-white opacity-10 rounded-full blur-2xl -mr-10 -mt-10 transition-transform group-hover:scale-150 duration-700">
                </div>

                <div class="flex items-center gap-3 mb-4 relative z-10">
                    <img id="sidebar-avatar" src=""
                        class="w-12 h-12 rounded-full border-2 border-white/30 object-cover bg-white/10 backdrop-blur-sm">
                    <div>
                        <h3 id="sidebar-name" class="font-bold text-lg leading-tight truncate w-32">Loading...</h3>
                        <p id="sidebar-level"
                            class="text-xs text-white/80 font-medium uppercase tracking-wider bg-black/20 inline-block px-2 py-0.5 rounded-md mt-1">
                            Beginner</p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-2 relative z-10">
                    <div
                        class="bg-black/20 rounded-xl p-2 text-center backdrop-blur-sm border border-white/10 flex flex-col items-center justify-center">
                        <div class="text-[10px] text-white/70 uppercase font-bold mb-0.5">BMI Score</div>
                        <div id="sidebar-bmi" class="text-xl font-black tracking-tight leading-none mb-1">--.-</div>
                        <div id="sidebar-bmi-cat" class="hidden"></div>
                    </div>
                    <div
                        class="bg-black/20 rounded-xl p-2 text-center backdrop-blur-sm border border-white/10 flex flex-col items-center justify-center">
                        <div class="text-[10px] text-white/70 uppercase font-bold mb-0.5">Goal</div>
                        <div id="sidebar-goal-icon" class="text-lg mb-1"><i class="fas fa-bullseye"></i></div>
                        <div id="sidebar-goal-text"
                            class="text-[9px] font-bold text-white/90 uppercase tracking-wider leading-none">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation & Chat History -->
        <nav class="flex-1 overflow-y-auto px-4 py-2 space-y-1">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider px-3 mb-2 mt-4">Chats</div>

            <!-- New Chat Button -->
            <button onclick="createNewConversation()"
                class="w-full flex items-center gap-3 px-3 py-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-xl font-semibold transition-all group border border-dashed border-slate-200 dark:border-slate-700 hover:border-brand-300 dark:hover:border-brand-600">
                <span
                    class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-500 flex items-center justify-center group-hover:bg-brand-50 group-hover:text-brand-600 transition-colors"><i
                        class="fas fa-plus"></i></span>
                New Chat
            </button>

            <!-- Chat History List -->
            <div id="chat-history-list" class="mt-3 space-y-1">
                <!-- Populated by JavaScript -->
                <div class="text-center py-4 text-slate-400 text-sm">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
            </div>
        </nav>

        <!-- Footer -->
        <div class="p-4 border-t border-slate-100 dark:border-slate-700">
            <button onclick="openSettings()"
                class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors group border border-transparent hover:border-slate-200 dark:hover:border-slate-600">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-500 flex items-center justify-center group-hover:text-slate-700">
                        <i class="fas fa-cog"></i>
                    </div>
                    <span class="font-medium text-sm text-slate-600 dark:text-slate-300">Settings</span>
                </div>
            </button>
        </div>
    </aside>

    <!-- MAIN CHAT AREA -->
    <main class="flex-1 flex flex-col relative h-full w-full bg-white/50 dark:bg-dark-900">

        <!-- Top Bar (Mobile Only) -->
        <header
            class="md:hidden h-16 bg-white/80 dark:bg-dark-900/80 backdrop-blur-md border-b border-slate-100 dark:border-slate-800 flex items-center justify-between px-4 z-20 sticky top-0">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center overflow-hidden shrink-0">
                    <img src="/static/atlasIcon.png" class="w-full h-full object-contain drop-shadow-lg">
                </div>
                <span class="font-bold text-lg">Atlas</span>
            </div>
            <button onclick="toggleMobileSidebar()"
                class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative">

            <!-- Welcome Screen -->
            <div id="welcome-screen"
                class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-0">
                <div class="relative w-32 h-32 mb-8 animate-float">
                    <div class="absolute inset-0 bg-brand-500 blur-3xl opacity-20 rounded-full"></div>
                    <img src="/static/atlasIcon.png" class="w-full h-full object-contain drop-shadow-2xl relative z-10">
                </div>
                <h1 class="text-4xl md:text-5xl font-black mb-4 tracking-tight text-slate-900 dark:text-white">
                    Hey, <span id="welcome-name"
                        class="text-transparent bg-clip-text bg-gradient-to-r from-brand-500 to-brand-600">Friend</span>
                </h1>
                <p class="text-slate-500 dark:text-slate-400 max-w-md text-lg font-medium leading-relaxed mb-8">
                    Your personal AI coach is ready. Let's hit those goals together.
                </p>

                <!-- Complete Profile Button (shown for incomplete profiles) -->
                <div id="complete-profile-prompt" class="hidden w-full max-w-md px-4 mb-6">
                    <div
                        class="bg-gradient-to-r from-brand-50 to-brand-100 dark:from-brand-900/30 dark:to-brand-800/30 border border-brand-200 dark:border-brand-700 rounded-2xl p-5">
                        <div class="flex items-center gap-3 mb-3">
                            <div
                                class="w-10 h-10 rounded-full bg-brand-500 text-white flex items-center justify-center">
                                <i class="fas fa-user-edit"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 dark:text-white">Complete Your Profile</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Get personalized workout &
                                    nutrition plans</p>
                            </div>
                        </div>
                        <button onclick="startOnboarding()"
                            class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl shadow-lg shadow-brand-500/20 transition-all active:scale-95">
                            <i class="fas fa-rocket mr-2"></i>Start Setup
                        </button>
                    </div>
                </div>

                <!-- Quick Starters (hidden for incomplete profiles) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-2xl px-4 pointer-events-auto"
                    id="suggestion-grid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Messages List -->
            <div id="messages-list" class="space-y-6 relative z-10 pb-24 max-w-3xl mx-auto"></div>

            <!-- Scroll to Bottom Button -->
            <button id="scroll-to-bottom" onclick="scrollToBottom()"
                class="fixed bottom-32 right-6 md:right-10 w-12 h-12 bg-brand-600 hover:bg-brand-700 text-white rounded-full shadow-lg shadow-brand-500/30 flex items-center justify-center transition-all transform translate-y-20 opacity-0 pointer-events-none z-40 hover:scale-110">
                <i class="fas fa-arrow-down text-lg"></i>
            </button>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:p-6 w-full max-w-3xl mx-auto z-30">
            <div id="active-suggestions" class="flex gap-2 mb-3 overflow-x-auto scrollbar-hide hidden p-1"></div>

            <!-- Cleaned up double border issue here -->
            <form onsubmit="handleSendMessage(event)"
                class="chat-input-container relative flex items-center gap-2 bg-white dark:bg-dark-800 p-2 pl-5 rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-black/20 transition-all">
                <input id="user-input" autocomplete="off"
                    class="flex-1 bg-transparent border-none focus:ring-0 text-slate-700 dark:text-slate-200 placeholder-slate-400 text-lg py-3 outline-none"
                    placeholder="Ask for a workout, meal plan, or advice...">

                <button type="submit" id="send-btn"
                    class="w-12 h-12 bg-gradient-to-tr from-brand-600 to-brand-500 text-white rounded-2xl shadow-lg shadow-brand-500/30 hover:shadow-brand-500/50 hover:scale-105 active:scale-95 transition-all flex items-center justify-center">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
            <p class="text-center text-[10px] text-slate-400 mt-3 font-semibold tracking-wide uppercase opacity-70">
                Atlas can make mistakes • Consult a health expert before starting
            </p>
        </div>
    </main>

    <!-- RECIPE MODAL (GEMINI POWERED) -->
    <div id="recipe-modal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-all opacity-0">
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-xl shadow-2xl transform scale-95 transition-all border border-slate-200 dark:border-slate-700 max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div
                class="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-brand-50 to-amber-50 dark:from-slate-800 dark:to-slate-800">
                <div class="flex items-center gap-3">
                    <div
                        class="w-11 h-11 rounded-xl bg-amber-500 text-white flex items-center justify-center text-lg shadow-lg">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-slate-800 dark:text-white">Atlas Chef</h2>
                        <p class="text-xs text-slate-500 dark:text-slate-400">AI-Powered Recipes</p>
                    </div>
                </div>
                <button onclick="closeRecipeModal()"
                    class="w-10 h-10 rounded-full bg-white dark:bg-slate-700 text-slate-400 hover:text-brand-600 hover:bg-slate-50 dark:hover:bg-slate-600 transition-all flex items-center justify-center shadow-sm border border-slate-200 dark:border-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>

            <!-- Recipe Content (Scrollable) -->
            <div id="recipe-content" class="flex-1 overflow-y-auto">
                <!-- Recipe Loaded Here -->
                <div class="flex flex-col items-center justify-center py-16">
                    <div class="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin"></div>
                    <p class="mt-4 text-sm font-bold text-slate-400">Cooking up your recipe...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-200 opacity-0">
        <div
            class="bg-white dark:bg-dark-800 rounded-3xl w-full max-w-sm shadow-2xl transform scale-95 transition-all border border-slate-100 dark:border-slate-700">
            <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-lg font-bold">Settings</h2>
                <button onclick="closeSettings()"
                    class="w-8 h-8 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-center text-slate-500"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-4">
                <button onclick="openProfileModal(); closeSettings();"
                    class="w-full flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 font-semibold hover:bg-brand-50 dark:hover:bg-brand-900/20 hover:text-brand-600 transition-colors">
                    <i class="fas fa-user-edit text-slate-400"></i> Edit Profile
                </button>
                <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50">
                    <span class="font-semibold text-sm">Dark Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" onchange="toggleDarkMode()">
                        <div
                            class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600">
                        </div>
                    </label>
                </div>
                <button onclick="resetPreferences()"
                    class="w-full flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 font-semibold hover:bg-amber-50 dark:hover:bg-amber-900/20 hover:text-amber-600 transition-colors">
                    <i class="fas fa-eraser text-slate-400"></i> Reset Preferences
                </button>
                <button onclick="handleLogout()"
                    class="w-full py-3 rounded-xl border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">Sign
                    Out</button>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL (Form) -->
    <div id="profile-modal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-all opacity-0">
        <div
            class="bg-white dark:bg-dark-800 rounded-[2rem] w-full max-w-xl p-8 shadow-2xl transform scale-95 transition-all border border-slate-100 dark:border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-slate-900 dark:text-white">Update Profile</h2>
                <button onclick="closeProfileModal()"
                    class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-brand-600 transition-colors flex items-center justify-center"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="profile-form" onsubmit="handleProfileUpdate(event)" class="space-y-6">

                <!-- Profile Photo Upload -->
                <div class="flex flex-col items-center mb-6">
                    <div class="relative group">
                        <div id="profile-photo-preview"
                            class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-slate-200 dark:border-slate-600 shadow-lg">
                            <span id="profile-photo-initial"
                                class="text-3xl font-black text-slate-400 dark:text-slate-500">?</span>
                            <img id="profile-photo-img" src="" class="hidden w-full h-full object-cover">
                        </div>
                        <label for="profile-photo-input"
                            class="absolute inset-0 rounded-full bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer flex items-center justify-center">
                            <i class="fas fa-camera text-white text-xl"></i>
                        </label>
                        <input type="file" id="profile-photo-input" accept="image/*" class="hidden"
                            onchange="handlePhotoSelect(event)">
                    </div>
                    <p class="text-xs text-slate-400 mt-2">Click to upload photo</p>
                </div>

                <!-- Name & Age -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">Display
                            Name</label>
                        <input type="text" id="edit-name" class="modern-input" placeholder="Your Name">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">Age</label>
                        <input type="number" id="edit-age" class="modern-input" placeholder="25">
                    </div>
                </div>

                <!-- Gender -->
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">Gender</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="selectGender(this, 'Male')"
                            class="visual-gender p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 cursor-pointer flex items-center justify-center gap-2 group transition-all">
                            <i class="fas fa-mars text-blue-500 text-xl group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold text-slate-600 dark:text-slate-300">Male</span>
                        </div>
                        <div onclick="selectGender(this, 'Female')"
                            class="visual-gender p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 cursor-pointer flex items-center justify-center gap-2 group transition-all">
                            <i
                                class="fas fa-venus text-pink-500 text-xl group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold text-slate-600 dark:text-slate-300">Female</span>
                        </div>
                    </div>
                    <input type="hidden" id="edit-gender">
                </div>

                <!-- Stats with Live BMI -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">Height
                            (cm)</label>
                        <input type="number" id="edit-height" oninput="calculateLiveBMI()" class="modern-input"
                            placeholder="175">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">Weight
                            (kg)</label>
                        <input type="number" id="edit-weight" oninput="calculateLiveBMI()" class="modern-input"
                            placeholder="70">
                    </div>
                </div>

                <!-- BMI Display -->
                <div id="bmi-display-area"
                    class="hidden bg-slate-50 dark:bg-slate-700/30 rounded-xl p-4 border border-slate-100 dark:border-slate-700 flex justify-between items-center">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase">Your BMI</div>
                        <div class="text-2xl font-black text-slate-800 dark:text-white" id="live-bmi-score">--.-</div>
                    </div>
                    <div id="live-bmi-badge" class="px-3 py-1 rounded-lg text-sm font-bold bg-gray-200 text-gray-700">
                        Calculated</div>
                </div>

                <!-- Goals -->
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">Goal</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div onclick="selectGoal(this, 'Weight Loss')"
                            class="visual-option p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 hover:border-brand-200 cursor-pointer flex flex-col items-center gap-1 text-center group transition-all">
                            <i
                                class="fas fa-fire text-orange-500 text-xl mb-1 group-hover:scale-110 transition-transform"></i><span
                                class="text-xs font-bold text-slate-600 dark:text-slate-300">Lose Weight</span>
                        </div>
                        <div onclick="selectGoal(this, 'Muscle Gain')"
                            class="visual-option p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 hover:border-brand-200 cursor-pointer flex flex-col items-center gap-1 text-center group transition-all">
                            <i
                                class="fas fa-dumbbell text-blue-500 text-xl mb-1 group-hover:scale-110 transition-transform"></i><span
                                class="text-xs font-bold text-slate-600 dark:text-slate-300">Build Muscle</span>
                        </div>
                        <div onclick="selectGoal(this, 'Maintenance')"
                            class="visual-option p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 hover:border-brand-200 cursor-pointer flex flex-col items-center gap-1 text-center group transition-all">
                            <i
                                class="fas fa-balance-scale text-green-500 text-xl mb-1 group-hover:scale-110 transition-transform"></i><span
                                class="text-xs font-bold text-slate-600 dark:text-slate-300">Maintain</span>
                        </div>
                    </div>
                    <input type="hidden" id="edit-goal">
                </div>

                <!-- Levels -->
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">Level</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="selectLevel(this, 'Beginner')"
                            class="visual-level p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 cursor-pointer text-center text-sm font-bold text-slate-600 dark:text-slate-300">
                            Beginner</div>
                        <div onclick="selectLevel(this, 'Intermediate')"
                            class="visual-level p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 cursor-pointer text-center text-sm font-bold text-slate-600 dark:text-slate-300">
                            Intermediate</div>
                    </div>
                    <input type="hidden" id="edit-level">
                </div>

                <!-- Medical Conditions -->
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">Medical
                        Conditions / Injuries</label>
                    <textarea id="edit-conditions" rows="2" class="modern-input"
                        placeholder="E.g. Knee pain, Lower back injury, None"></textarea>
                </div>

                <button type="submit"
                    class="w-full py-4 bg-brand-600 text-white font-bold text-lg rounded-2xl shadow-lg shadow-brand-600/30 hover:bg-brand-700 hover:scale-[1.02] active:scale-95 transition-all">Save
                    Profile</button>
            </form>
        </div>
    </div>



    <script>
        // ================= CONFIGURATION =================
        // Firebase config is now loaded from backend to avoid exposing in source
        let auth;
        let currentUser = null;
        let backendSession = {};
        let userProfileCache = {};
        let isOnboarding = false;
        let onboardingStep = 0;
        let onboardingData = {};
        let conversationState = null;
        let isProfileComplete = false;
        let currentConversationId = null;
        let conversationsList = [];

        async function initFirebase() {
            try {
                const backendURL = window.API_CONFIG?.BASE_URL || '';
                const response = await fetch(`${backendURL}/api/firebase-config`);
                const firebaseConfig = await response.json();

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();

                // Set up auth state listener after Firebase is ready
                auth.onAuthStateChanged(handleAuthChange);
            } catch (error) {
                console.error('Failed to load Firebase config:', error);
                window.location.href = '/';
            }
        }

        // Initialize Firebase on page load
        initFirebase();

        // Handle authentication state changes
        async function handleAuthChange(user) {
            if (user) {
                // User is signed in
                currentUser = user;
                console.log('User logged in:', user.uid);

                // Load user profile and initialize chat
                await loadUserProfile(user.uid);
                loadConversations();

                // Update sidebar with user info
                updateSidebarUserInfo();
            } else {
                // User is not signed in, redirect to login
                console.log('No user signed in, redirecting to login');
                window.location.href = '/';
            }
        }

        // Update sidebar with user info
        function updateSidebarUserInfo() {
            if (!currentUser || !userProfileCache) return;

            const nameEl = document.getElementById('sidebar-name');
            const avatarEl = document.getElementById('sidebar-avatar');
            const levelEl = document.getElementById('sidebar-level');
            const bmiEl = document.getElementById('sidebar-bmi');
            const goalEl = document.getElementById('sidebar-goal-text');
            const welcomeEl = document.getElementById('welcome-name');

            if (nameEl && userProfileCache.name) {
                nameEl.textContent = userProfileCache.name;
                if (welcomeEl) welcomeEl.textContent = userProfileCache.name.split(' ')[0];
            }

            if (avatarEl) {
                if (userProfileCache.photoURL) {
                    avatarEl.src = userProfileCache.photoURL;
                } else if (currentUser.photoURL) {
                    avatarEl.src = currentUser.photoURL;
                } else {
                    avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfileCache.name || 'User')}&background=e11d48&color=fff`;
                }
            }

            if (levelEl && userProfileCache.fitness_level) {
                levelEl.textContent = userProfileCache.fitness_level;
            }

            if (bmiEl && userProfileCache.bmi) {
                bmiEl.textContent = parseFloat(userProfileCache.bmi).toFixed(1);
            }

            if (goalEl && userProfileCache.goal) {
                goalEl.textContent = userProfileCache.goal;
            }
        }


        // Suggestions Logic
        const SUGGESTIONS = {
            'initial': [
                { text: "Chest Workout", icon: "fa-dumbbell", type: "fitness" },
                { text: "Back Workout", icon: "fa-dumbbell", type: "fitness" },
                { text: "Breakfast Idea", icon: "fa-egg", type: "nutrition" },
                { text: "High Protein Snack", icon: "fa-cookie-bite", type: "nutrition" }
            ],
            'fitness_drilldown': [
                { text: "Suggest different exercise", icon: "fa-sync", type: "fitness" },
                { text: "Suggest different body part", icon: "fa-child", type: "fitness" }
            ],
            'nutrition_drilldown': [
                { text: "Suggest different meal", icon: "fa-utensils", type: "nutrition" },
                { text: "Suggest different category", icon: "fa-leaf", type: "nutrition" }
            ]
        };

        // ================= UI FUNCTIONS =================

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        // Show/hide scroll-to-bottom button based on scroll position
        function updateScrollButton() {
            const container = document.getElementById('chat-container');
            const button = document.getElementById('scroll-to-bottom');
            const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 200;

            if (isNearBottom) {
                button.classList.add('translate-y-20', 'opacity-0', 'pointer-events-none');
            } else {
                button.classList.remove('translate-y-20', 'opacity-0', 'pointer-events-none');
            }
        }

        // Add scroll listener after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('chat-container');
            if (container) {
                container.addEventListener('scroll', updateScrollButton);
            }
        });

        function toggleDarkMode() {
            const isDark = document.getElementById('dark-mode-toggle').checked;
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Apply Saved Theme
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            if (document.getElementById('dark-mode-toggle')) document.getElementById('dark-mode-toggle').checked = true;
        }

        function openSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
        }

        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        // Reset user preferences (likes/dislikes)
        async function resetPreferences() {
            if (!confirm('This will clear all your saved likes and dislikes. Continue?')) return;

            try {
                // Clear preferences via backend
                const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/reset-preferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.uid })
                });

                const data = await response.json();
                if (data.success) {
                    // Clear local session data
                    backendSession.likes = [];
                    backendSession.dislikes = [];

                    // Show success message
                    closeSettings();
                    addMessage('<div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-xl border border-emerald-200 dark:border-emerald-800"><b class="text-emerald-700 dark:text-emerald-300"><i class="fas fa-check-circle mr-2"></i>Preferences Reset!</b><p class="text-sm text-emerald-600 dark:text-emerald-400 mt-1">Your likes and dislikes have been cleared. I\'ll now give you fresh recommendations!</p></div>', 'ai', false);
                } else {
                    alert('Failed to reset preferences. Please try again.');
                }
            } catch (error) {
                console.error('Error resetting preferences:', error);
                alert('Error resetting preferences. Please try again.');
            }
        }



        // --- ✨ GEMINI RECIPE MODAL LOGIC ---
        function getRecipe(foodName) {
            const modal = document.getElementById('recipe-modal');
            const content = document.getElementById('recipe-content');

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            // Show Loading State
            content.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12">
                <div class="w-12 h-12 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin"></div>
                <p class="mt-4 text-sm font-bold text-slate-400 animate-pulse">Atlas AI Chef is cooking...</p>
            </div>
        `;

            // Fetch Recipe from Backend (Gemini)
            fetch(`${window.API_CONFIG?.BASE_URL || ''}/generate-recipe`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUser.uid, food_name: foodName })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        content.innerHTML = data.recipe;
                    } else {
                        content.innerHTML = `<div class="text-center p-6 text-red-500 font-bold">Chef is busy! Please try again.</div>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    content.innerHTML = `<div class="text-center p-6 text-red-500 font-bold">Connection Error.</div>`;
                });
        }

        function closeRecipeModal() {
            const modal = document.getElementById('recipe-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function resetChat() {
            document.getElementById('messages-list').innerHTML = '';
            backendSession = {};
            currentConversationId = null;
            document.getElementById('welcome-screen').classList.remove('hidden');
            if (window.innerWidth < 768) toggleMobileSidebar();
            // Refresh conversation list to show proper active state
            loadConversations();
        }

        // ================= TIMESTAMP HELPER FUNCTIONS =================

        /**
         * Parse Firestore timestamp to JavaScript Date object
         * Handles various timestamp formats from Firestore
         */
        function parseTimestamp(timestamp) {
            if (!timestamp) return null;

            // If it's already a Date object
            if (timestamp instanceof Date) return timestamp;

            // If it's a Firestore Timestamp object with seconds
            if (timestamp.seconds) {
                return new Date(timestamp.seconds * 1000);
            }

            // If it's a Firestore Timestamp with _seconds (older format)
            if (timestamp._seconds) {
                return new Date(timestamp._seconds * 1000);
            }

            // If it's an ISO string
            if (typeof timestamp === 'string') {
                return new Date(timestamp);
            }

            // If it's a number (Unix milliseconds)
            if (typeof timestamp === 'number') {
                return new Date(timestamp);
            }

            return null;
        }

        /**
         * Format a date as relative time (e.g., "5 minutes ago", "2 hours ago")
         * Uses local timezone for accurate display
         */
        function formatTimeAgo(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return '';
            }

            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSeconds < 60) {
                return 'Just now';
            } else if (diffMinutes < 60) {
                return `${diffMinutes}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                // For older dates, show the actual date
                return date.toLocaleDateString();
            }
        }

        // ================= CHAT HISTORY FUNCTIONS =================

        async function loadConversations() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/conversations?user_id=${currentUser.uid}`);
                const data = await response.json();

                if (data.success) {
                    conversationsList = data.conversations;
                    renderConversationsList();
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('chat-history-list').innerHTML = `
                    <div class="text-center py-4 text-slate-400 text-sm">
                        <i class="fas fa-exclamation-circle"></i> Could not load history
                    </div>
                `;
            }
        }

        function renderConversationsList() {
            const container = document.getElementById('chat-history-list');

            if (conversationsList.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-slate-400 text-sm">
                        <i class="fas fa-comments text-2xl mb-2 opacity-50"></i>
                        <p>No conversations yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = conversationsList.map(conv => {
                const isActive = conv.id === currentConversationId;
                const timeAgo = conv.updated_at ? formatTimeAgo(parseTimestamp(conv.updated_at)) : '';

                return `
                    <div class="group relative">
                        <button onclick="loadConversation('${conv.id}')"
                            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl font-medium transition-all text-left
                            ${isActive
                        ? 'bg-brand-50 dark:bg-brand-900/20 text-brand-600 dark:text-brand-400'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50'}">
                            <span class="w-7 h-7 rounded-lg ${isActive ? 'bg-white dark:bg-slate-800 text-brand-600' : 'bg-slate-100 dark:bg-slate-700 text-slate-400'} flex items-center justify-center text-sm">
                                <i class="fas fa-comment"></i>
                            </span>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm truncate">${escapeHtml(conv.title)}</div>
                                <div class="text-[10px] text-slate-400 dark:text-slate-500">${timeAgo}</div>
                            </div>
                        </button>
                        <button onclick="event.stopPropagation(); deleteConversation('${conv.id}')"
                            class="absolute right-2 top-1/2 -translate-y-1/2 w-7 h-7 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-500 
                            opacity-0 group-hover:opacity-100 hover:bg-red-100 dark:hover:bg-red-900/40 transition-all flex items-center justify-center">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function createNewConversation() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/conversations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.uid })
                });
                const data = await response.json();

                if (data.success) {
                    currentConversationId = data.conversation.id;

                    // Reset chat UI to first login state
                    document.getElementById('messages-list').innerHTML = '';
                    backendSession = {};

                    // Show welcome screen
                    document.getElementById('welcome-screen').classList.remove('hidden');

                    // Hide active suggestions bar (the mini pills above input)
                    document.getElementById('active-suggestions').classList.add('hidden');

                    // Render initial suggestion grid on welcome screen (if profile complete)
                    if (isProfileComplete) {
                        renderSuggestions('initial');
                    }

                    // Add to list and re-render
                    conversationsList.unshift(data.conversation);
                    renderConversationsList();

                    if (window.innerWidth < 768) toggleMobileSidebar();
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
            }
        }


        async function loadConversation(conversationId) {
            if (!currentUser) return;

            try {
                const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/conversations/${conversationId}?user_id=${currentUser.uid}`);
                const data = await response.json();

                if (data.success) {
                    currentConversationId = conversationId;
                    backendSession = data.conversation.session || {};

                    // Clear and populate messages
                    document.getElementById('messages-list').innerHTML = '';
                    document.getElementById('welcome-screen').classList.add('hidden');

                    // Render each message
                    data.conversation.messages.forEach(msg => {
                        addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                    });

                    // Update active state in list
                    renderConversationsList();

                    if (window.innerWidth < 768) toggleMobileSidebar();
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        async function deleteConversation(conversationId) {
            if (!currentUser) return;
            if (!confirm('Delete this conversation?')) return;

            try {
                const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.uid })
                });
                const data = await response.json();

                if (data.success) {
                    // Remove from list
                    conversationsList = conversationsList.filter(c => c.id !== conversationId);
                    renderConversationsList();

                    // If deleted current conversation, reset
                    if (currentConversationId === conversationId) {
                        resetChat();
                    }
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
            }
        }

        async function saveMessageToConversation(role, content) {
            if (!currentUser || !currentConversationId) return;

            try {
                const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/conversations/${currentConversationId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.uid,
                        role: role,
                        content: content,
                        session: backendSession
                    })
                });
                const data = await response.json();

                if (data.success && data.title) {
                    // Update title in list if changed
                    const conv = conversationsList.find(c => c.id === currentConversationId);
                    if (conv && conv.title !== data.title) {
                        conv.title = data.title;
                        renderConversationsList();
                    }
                }
            } catch (error) {
                console.error('Error saving message:', error);
            }
        }

        // Helper functions
        function formatTimeAgo(date) {
            // Handle invalid dates
            if (!date || isNaN(date.getTime())) {
                return '';
            }

            const now = new Date();
            const diff = Math.floor((now.getTime() - date.getTime()) / 1000);

            // Debug log
            console.log('Time diff (seconds):', diff, 'Date:', date.toISOString(), 'Now:', now.toISOString());

            // Handle future dates or very recent
            if (diff < 0) return 'Just now';
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function parseTimestamp(timestamp) {
            // Handle null/undefined
            if (!timestamp) return null;

            // If it's already a Date object
            if (timestamp instanceof Date) return timestamp;

            if (typeof timestamp === 'string') {
                // Parse ISO string manually to ensure local time interpretation
                // Format: 2025-12-31T16:30:00.123456 (without timezone)
                const match = timestamp.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
                if (match) {
                    const [_, year, month, day, hour, minute, second] = match;
                    // Create date using local timezone
                    return new Date(
                        parseInt(year),
                        parseInt(month) - 1, // Month is 0-indexed
                        parseInt(day),
                        parseInt(hour),
                        parseInt(minute),
                        parseInt(second)
                    );
                }
            }

            // Fallback to standard Date parsing
            return new Date(timestamp);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ================= PROFILE STATS LOGIC =================

        function updateProfileCard(profile) {
            // Name
            document.getElementById('sidebar-name').innerText = profile.name || "User";
            document.getElementById('welcome-name').innerText = profile.name || "Friend";

            // Avatar handling - Priority: 1. Custom photo_url, 2. Google photo, 3. Initial letter
            const avatarEl = document.getElementById('sidebar-avatar');
            const userName = profile.name || (currentUser && currentUser.displayName) || "User";
            const firstLetter = userName.charAt(0).toUpperCase();

            if (profile.photo_url) {
                // Use custom uploaded photo
                avatarEl.src = profile.photo_url;
            } else if (currentUser && currentUser.photoURL) {
                // Use Google photo
                avatarEl.src = currentUser.photoURL;
            } else {
                // Fallback to initial letter avatar
                avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(firstLetter)}&background=e11d48&color=fff&bold=true&size=128`;
            }


            // Level
            document.getElementById('sidebar-level').innerText = profile.fitness_level || "Beginner";

            // Goal Icon & Text
            const goalMap = { 'Weight Loss': 'fa-fire', 'Muscle Gain': 'fa-dumbbell', 'Maintenance': 'fa-balance-scale' };
            const goalIcon = goalMap[profile.goal] || 'fa-heartbeat';
            document.getElementById('sidebar-goal-icon').innerHTML = `<i class="fas ${goalIcon}"></i>`;
            document.getElementById('sidebar-goal-text').innerText = profile.goal || "General";

            // BMI Calculation
            let bmiDisplay = "--.-";
            const bmiCatEl = document.getElementById('sidebar-bmi-cat');

            if (profile.weight && profile.height) {
                const h = profile.height / 100;
                const bmi = (profile.weight / (h * h)).toFixed(1);
                bmiDisplay = bmi;

                // Category Logic
                bmiCatEl.classList.remove('hidden');
                let cat = '', colorClass = '';

                if (bmi < 18.5) { cat = 'Underweight'; colorClass = 'text-blue-600 bg-white'; }
                else if (bmi < 25) { cat = 'Normal'; colorClass = 'text-green-600 bg-white'; }
                else if (bmi < 30) { cat = 'Overweight'; colorClass = 'text-orange-500 bg-white'; }
                else { cat = 'Obese'; colorClass = 'text-red-600 bg-white'; }

                bmiCatEl.innerText = cat;
                bmiCatEl.className = `text-[8px] font-extrabold px-2 py-0.5 rounded-full uppercase tracking-wider ${colorClass} shadow-sm`;
            } else {
                bmiCatEl.classList.add('hidden');
            }
            document.getElementById('sidebar-bmi').innerText = bmiDisplay;
        }

        // ================= CORE APP LOGIC =================

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('suggestion-grid').innerHTML = '';
        });

        // Add to your existing auth state change handler
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;

                // --- 1. USER PHOTO HANDLING ---
                const avatarEl = document.getElementById('sidebar-avatar');
                if (user.photoURL) {
                    avatarEl.src = user.photoURL;
                } else {
                    // Default avatar based on name or 'User'
                    const name = user.displayName || "User";
                    avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e11d48&color=fff&bold=true`;
                }


                await loadUserProfile(user.uid);
                await loadConversations(); // Load chat history
                await performMorningCheckin(user.uid);
            }
        });



        async function loadUserProfile(uid) {
            try {
                const res = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/load-profile`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: uid }) });
                const data = await res.json();

                if (data.success) {
                    userProfileCache = data.profile;
                    updateProfileCard(userProfileCache); // UPDATE SIDEBAR

                    // Check if profile is complete (has weight, height, goal)
                    isProfileComplete = !!(userProfileCache.weight && userProfileCache.height && userProfileCache.goal);

                    // Show/hide elements based on profile completion
                    const completeProfilePrompt = document.getElementById('complete-profile-prompt');
                    const suggestionGrid = document.getElementById('suggestion-grid');

                    if (isProfileComplete) {
                        completeProfilePrompt.classList.add('hidden');
                        renderSuggestions('initial');
                    } else {
                        // Show complete profile button, hide suggestions
                        completeProfilePrompt.classList.remove('hidden');
                        suggestionGrid.innerHTML = ''; // Clear suggestions
                    }
                }
            } catch (e) { console.error("Profile Load Error", e); }
        }

        async function handleSendMessage(e) {
            if (e) e.preventDefault();
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            // Auto-create conversation if none exists
            if (!currentConversationId && currentUser) {
                try {
                    const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/conversations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: currentUser.uid })
                    });
                    const data = await response.json();
                    if (data.success) {
                        currentConversationId = data.conversation.id;
                        conversationsList.unshift(data.conversation);
                        renderConversationsList();
                    }
                } catch (error) {
                    console.error('Error creating conversation:', error);
                }
            }

            addMessage(text, 'user');
            // Save user message to conversation
            saveMessageToConversation('user', text);

            input.value = '';

            if (isOnboarding) { handleOnboardingInput(text); return; }

            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('active-suggestions').classList.remove('hidden');
            showTyping();

            let messageToSend = text;

            // Handle explicit body part context
            if (conversationState === 'awaiting_body_part') {
                messageToSend = "Suggest workouts for " + text;
                conversationState = null; // Reset state
            } else if (conversationState === 'awaiting_meal_category') {
                messageToSend = "Suggest healthy options for " + text;
                conversationState = null;
            }

            try {
                const res = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/get-recommendation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.uid, message: messageToSend, session: backendSession })
                });
                const data = await res.json();

                removeTyping();
                if (data.session) backendSession = data.session;

                if (data.reply) {
                    addMessage(data.reply, 'ai');
                    // Save AI response to conversation
                    saveMessageToConversation('ai', data.reply);

                    // If weight was logged, refresh the profile to update BMI display
                    if (data.intent === 'log_weight') {
                        await loadUserProfile(currentUser.uid);
                    }

                    // Suggestion Logic
                    if (data.intent && data.intent.includes('fitness')) renderSuggestions('fitness_drilldown', true);
                    else if (data.intent && data.intent.includes('nutrition')) renderSuggestions('nutrition_drilldown', true);
                    else renderSuggestions('initial', true);
                }

            } catch (error) {
                removeTyping();
                addMessage("Sorry, I couldn't reach the server.", 'ai');
            }
        }

        function addMessage(html, sender, useTypingAnimation = true) {
            const list = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.className = `flex gap-4 max-w-3xl mx-auto message-enter ${sender === 'user' ? 'justify-end' : ''}`;

            // Convert markdown to HTML for AI messages
            const content = sender === 'ai' ? formatAIMessage(html) : html;

            const bubble = sender === 'ai'
                ? `bg-white dark:bg-dark-800 border border-slate-100 dark:border-slate-700 text-slate-700 dark:text-slate-200 w-full rounded-2xl rounded-tl-sm p-6 shadow-sm`
                : `bg-brand-600 text-white shadow-lg shadow-brand-600/20 rounded-3xl rounded-tr-sm px-6 py-3 font-medium`;

            const avatar = sender === 'ai'
                ? `<div class="w-12 h-12 rounded-xl shrink-0 flex items-center justify-center overflow-hidden">
                 <img src="/static/atlasIcon.png" class="w-full h-full object-contain drop-shadow-lg">
               </div>`
                : ``;

            div.innerHTML = sender === 'ai'
                ? `${avatar}<div class="${bubble} overflow-hidden leading-relaxed ai-message-content"></div>`
                : `<div class="${bubble}">${content}</div>`;

            list.appendChild(div);

            const container = document.getElementById('chat-container');
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });

            // Apply typing animation for AI messages
            if (sender === 'ai' && useTypingAnimation) {
                const contentDiv = div.querySelector('.ai-message-content');

                // Check if content has complex HTML (cards, tables, buttons)
                const hasComplexHTML = content.includes('<div') || content.includes('<table') || content.includes('<button') || content.includes('class="');

                if (hasComplexHTML) {
                    // For complex HTML, fade in the content instead of typing
                    contentDiv.style.opacity = '0';
                    contentDiv.innerHTML = content;
                    contentDiv.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        contentDiv.style.opacity = '1';
                        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                    }, 50);
                } else {
                    // For text content, use typing animation
                    typeMessage(contentDiv, content, () => {
                        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                    });
                }
            } else if (sender === 'ai') {
                div.querySelector('.ai-message-content').innerHTML = content;
            }
        }

        // Typing animation function
        function typeMessage(element, htmlContent, onComplete) {
            // Parse HTML to extract text and tags
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            // For simple text with basic HTML tags, type character by character
            const plainText = tempDiv.textContent || tempDiv.innerText;

            if (plainText.length > 500) {
                // For very long messages, just fade in
                element.style.opacity = '0';
                element.innerHTML = htmlContent;
                element.style.transition = 'opacity 0.4s ease';
                setTimeout(() => {
                    element.style.opacity = '1';
                    if (onComplete) onComplete();
                }, 50);
                return;
            }

            let index = 0;
            const speed = 8; // milliseconds per character (faster = smaller number)
            element.innerHTML = '';

            // Use word-by-word for HTML content
            const words = htmlContent.split(/(\s+)/);
            let wordIndex = 0;

            function typeWord() {
                if (wordIndex < words.length) {
                    element.innerHTML += words[wordIndex];
                    wordIndex++;

                    // Scroll during typing
                    const container = document.getElementById('chat-container');
                    container.scrollTop = container.scrollHeight;

                    setTimeout(typeWord, speed * 2);
                } else {
                    // Ensure final HTML is properly rendered
                    element.innerHTML = htmlContent;
                    if (onComplete) onComplete();
                }
            }

            typeWord();
        }


        // Convert markdown-style formatting to HTML for clean display
        function formatAIMessage(text) {
            if (!text) return '';

            // If the content already contains HTML tags (cards, etc.), return as-is
            // This prevents the markdown regex from corrupting pre-formatted HTML
            if (text.includes('<div') || text.includes('<table') || text.includes('<button')) {
                return text;
            }

            let formatted = text;

            // Protect code blocks first (``` ... ```)
            const codeBlocks = [];
            formatted = formatted.replace(/```([\s\S]*?)```/g, (match, code) => {
                codeBlocks.push(code.trim());
                return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
            });

            // Protect inline code (` ... `)
            const inlineCodes = [];
            formatted = formatted.replace(/`([^`]+)`/g, (match, code) => {
                inlineCodes.push(code);
                return `__INLINE_CODE_${inlineCodes.length - 1}__`;
            });

            // Convert headers (## Header)
            formatted = formatted.replace(/^### (.+)$/gm, '<h4 class="text-base font-bold text-slate-800 dark:text-white mt-5 mb-2">$1</h4>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h3 class="text-lg font-bold text-slate-800 dark:text-white mt-6 mb-3">$1</h3>');
            formatted = formatted.replace(/^# (.+)$/gm, '<h2 class="text-xl font-bold text-slate-800 dark:text-white mt-6 mb-3">$1</h2>');

            // Convert Phase/Section headers (Phase 1:, Image 1:, etc.)
            formatted = formatted.replace(/^(Phase \d+[:\.]\s*)(.+)$/gm, '<h3 class="text-lg font-bold text-brand-600 dark:text-brand-400 mt-6 mb-2"><i class="fas fa-layer-group mr-2"></i>$1$2</h3>');
            formatted = formatted.replace(/^(Image \d+[:\.]\s*)(.+)$/gm, '<h4 class="text-base font-semibold text-slate-700 dark:text-slate-200 mt-4 mb-2"><i class="fas fa-image mr-2 text-slate-400"></i>$1$2</h4>');
            formatted = formatted.replace(/^(Step \d+[:\.]\s*)(.+)$/gm, '<h4 class="text-base font-semibold text-slate-700 dark:text-slate-200 mt-4 mb-2"><i class="fas fa-arrow-right mr-2 text-brand-500"></i>$1$2</h4>');

            // Convert **bold** to styled bold
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="font-bold text-slate-900 dark:text-white">$1</strong>');

            // Convert *italic* to <em>italic</em>
            formatted = formatted.replace(/\*([^*<>]+?)\*/g, '<em class="italic text-slate-600 dark:text-slate-300">$1</em>');

            // Convert markdown links [text](url)
            formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-brand-600 dark:text-brand-400 underline hover:text-brand-700 dark:hover:text-brand-300 font-medium">$1</a>');

            // Convert markdown bullet points to HTML list
            const bulletRegex = /^[\-\*]\s+(.+)$/gm;
            const hasBullets = bulletRegex.test(formatted);
            if (hasBullets) {
                formatted = formatted.replace(/^[\-\*]\s+(.+)$/gm, '<li class="ml-5 mb-2 text-slate-600 dark:text-slate-300">$1</li>');
                formatted = formatted.replace(/(<li[^>]*>.*?<\/li>\s*)+/gs, '<ul class="list-disc list-outside my-4 space-y-1 pl-2">$&</ul>');
            }

            // Convert numbered lists (1. 2. 3.)
            const numberedRegex = /^\d+\.\s+(.+)$/gm;
            if (numberedRegex.test(formatted)) {
                formatted = formatted.replace(/^\d+\.\s+(.+)$/gm, '<li class="ml-5 mb-2 text-slate-600 dark:text-slate-300">$1</li>');
                formatted = formatted.replace(/(<li[^>]*>.*?<\/li>\s*)+/gs, '<ol class="list-decimal list-outside my-4 space-y-1 pl-2">$&</ol>');
            }

            // Convert The Goal:, This is:, etc. styled callouts
            formatted = formatted.replace(/^(The Goal:)\s*(.+)$/gm, '<div class="bg-brand-50 dark:bg-brand-900/30 border-l-4 border-brand-500 p-4 my-4 rounded-r-lg"><strong class="text-brand-700 dark:text-brand-300">$1</strong> <span class="text-slate-700 dark:text-slate-200">$2</span></div>');
            formatted = formatted.replace(/^(This is the most critical step\.)\s*(.+)$/gm, '<div class="bg-amber-50 dark:bg-amber-900/30 border-l-4 border-amber-500 p-4 my-4 rounded-r-lg"><strong class="text-amber-700 dark:text-amber-300"><i class="fas fa-exclamation-triangle mr-2"></i>$1</strong> <span class="text-slate-700 dark:text-slate-200">$2</span></div>');

            // Restore inline code with styling
            inlineCodes.forEach((code, i) => {
                formatted = formatted.replace(`__INLINE_CODE_${i}__`, `<code class="bg-slate-100 dark:bg-slate-700 text-brand-600 dark:text-brand-400 px-2 py-0.5 rounded text-sm font-mono">${code}</code>`);
            });

            // Restore code blocks with styling
            codeBlocks.forEach((code, i) => {
                formatted = formatted.replace(`__CODE_BLOCK_${i}__`, `<pre class="bg-slate-900 dark:bg-slate-950 text-slate-100 p-4 rounded-xl my-4 overflow-x-auto text-sm font-mono border border-slate-700"><code>${code}</code></pre>`);
            });

            // Convert line breaks
            formatted = formatted.replace(/\n\n/g, '</p><p class="mb-3">');
            formatted = formatted.replace(/\n/g, '<br>');

            // Wrap in paragraph if not already wrapped
            if (!formatted.startsWith('<')) {
                formatted = '<p class="mb-3">' + formatted + '</p>';
            }

            // Add styling for key metrics (numbers with units)
            formatted = formatted.replace(/(\d+(?:\.\d+)?)\s*(kg|lbs|cm|inches|calories|kcal|g|mg|%)/gi,
                '<span class="font-semibold text-brand-600 dark:text-brand-400">$1 $2</span>');

            return formatted;
        }


        function showTyping() {
            const list = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex gap-4 max-w-3xl mx-auto message-enter';
            div.innerHTML = `<div class="w-12 h-12 rounded-xl shrink-0 flex items-center justify-center overflow-hidden"><img src="/static/atlasIcon.png" class="w-full h-full object-contain drop-shadow-lg"></div><div class="bg-white dark:bg-dark-800 px-4 py-3 rounded-2xl rounded-tl-sm border border-slate-100 dark:border-slate-700 flex items-center gap-2 shadow-sm"><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div></div>`;
            list.appendChild(div);
            document.getElementById('chat-container').scrollTo({ top: document.getElementById('chat-container').scrollHeight, behavior: 'smooth' });
        }

        function removeTyping() { const el = document.getElementById('typing-indicator'); if (el) el.remove(); }
        function handleLogout() { auth.signOut().then(() => window.location.href = '/'); }

        function renderSuggestions(type, isMini = false) {
            // Don't show suggestions if profile is not complete
            if (!isProfileComplete) {
                document.getElementById('suggestion-grid').innerHTML = '';
                document.getElementById('active-suggestions').classList.add('hidden');
                return;
            }

            const items = SUGGESTIONS[type] || SUGGESTIONS['initial'];

            const generateOnClick = (itemText) => {
                if (itemText === "Suggest different body part") {
                    conversationState = 'awaiting_body_part';
                    return `addMessage('Which body part would you like to focus on?', 'ai')`;
                }
                if (itemText === "Suggest different category") {
                    conversationState = 'awaiting_meal_category';
                    return `addMessage('Which food category (e.g. Breakfast, Lunch, Dinner)?', 'ai')`;
                }
                return `sendQuick('${itemText}')`;
            };

            if (!isMini) {
                const grid = document.getElementById('suggestion-grid');
                grid.innerHTML = items.map(item => `
                <button onclick="${generateOnClick(item.text)}" class="flex items-center gap-4 p-4 bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 rounded-2xl hover:border-brand-500 dark:hover:border-brand-500 hover:shadow-lg transition-all text-left group">
                    <div class="w-10 h-10 rounded-full bg-brand-50 dark:bg-brand-900/20 text-brand-600 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="fas ${item.icon}"></i></div>
                    <div><div class="font-bold text-slate-700 dark:text-slate-200 text-sm">${item.text}</div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${item.type}</div></div>
                </button>
            `).join('');
            } else {
                const container = document.getElementById('active-suggestions');
                container.innerHTML = items.map(item => `
                <button onclick="${generateOnClick(item.text)}" class="whitespace-nowrap px-4 py-2 bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 rounded-full text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-brand-50 dark:hover:bg-slate-700 hover:border-brand-200 transition-all shadow-sm">${item.text}</button>
            `).join('');
                container.classList.remove('hidden');
            }
        }

        function sendQuick(text) {
            document.getElementById('user-input').value = text;
            handleSendMessage();
        }
    </script>

    <!-- ============================================ -->
    <!-- LIBRARY SIDEBAR (Gold Standard Vault)       -->
    <!-- ============================================ -->
    <div id="library-sidebar"
        class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 border-l border-slate-100 dark:border-slate-700 flex flex-col">
        <!-- Header -->
        <div
            class="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-amber-600 dark:text-amber-400">
                    <i class="fas fa-trophy text-sm"></i>
                </div>
                <h2 class="font-bold text-slate-800 dark:text-slate-100">Gold Standards</h2>
            </div>
            <button onclick="closeLibrary()"
                class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Tabs -->
        <div class="flex p-2 gap-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50">
            <button onclick="switchLibTab('workouts')" id="tab-workouts"
                class="flex-1 py-2 text-sm font-bold rounded-lg bg-white dark:bg-slate-800 text-brand-600 shadow-sm transition-all">Workouts</button>
            <button onclick="switchLibTab('nutrition')" id="tab-nutrition"
                class="flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all">Nutrition</button>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="library-content">
            <!-- Dynamic Content Loaded via JS -->
            <div class="text-center text-slate-400 mt-10">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br />Loading your vault...
            </div>
        </div>
    </div>

    <!-- Sticky Library Button -->
    <div class="fixed right-0 top-1/2 -translate-y-1/2 z-40">
        <button onclick="openLibrary()"
            class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 px-1 rounded-l-xl shadow-lg hover:pr-4 transition-all duration-300 group flex items-center gap-2 font-bold">
            <span class="rotate-180" style="writing-mode: vertical-rl; text-orientation: mixed;">MY VAULT</span>
            <div
                class="w-6 h-6 rounded-full bg-amber-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-star text-slate-900 text-xs"></i>
            </div>
        </button>
    </div>

    <script>
        // Modal & Onboarding Logic (Updated)
        function openProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            if (userProfileCache) {
                document.getElementById('edit-name').value = userProfileCache.name || '';
                document.getElementById('edit-age').value = userProfileCache.age || '';
                document.getElementById('edit-weight').value = userProfileCache.weight || '';
                document.getElementById('edit-height').value = userProfileCache.height || '';
                document.getElementById('edit-conditions').value = userProfileCache.medical_conditions || '';

                if (userProfileCache.gender) selectGender(null, userProfileCache.gender);
                if (userProfileCache.goal) {
                    const el = Array.from(document.querySelectorAll('.visual-option')).find(e => e.innerText.includes(userProfileCache.goal.split(' ')[0])); // Approximate match
                    if (el) selectGoal(el, userProfileCache.goal);
                }
                if (userProfileCache.fitness_level) {
                    const el = Array.from(document.querySelectorAll('.visual-level')).find(e => e.innerText.includes(userProfileCache.fitness_level));
                    if (el) selectLevel(el, userProfileCache.fitness_level);
                }

                calculateLiveBMI(); // Trigger update immediately
                initProfilePhotoPreview(); // Initialize photo preview
            }
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function selectGoal(el, v) {
            document.getElementById('edit-goal').value = v;
            document.querySelectorAll('.visual-option').forEach(opt => opt.classList.remove('selected', 'border-brand-500', 'bg-brand-50'));
            if (el) el.classList.add('selected');
            // Fallback selector for when el is null (e.g. initial load)
            else {
                const found = Array.from(document.querySelectorAll('.visual-option')).find(e => e.innerText.includes(v.split(' ')[0]));
                if (found) found.classList.add('selected');
            }
        }
        function selectLevel(el, v) {
            document.getElementById('edit-level').value = v;
            document.querySelectorAll('.visual-level').forEach(l => l.classList.remove('selected'));
            if (el) el.classList.add('selected');
            else {
                const found = Array.from(document.querySelectorAll('.visual-level')).find(e => e.innerText.includes(v));
                if (found) found.classList.add('selected');
            }
        }
        function selectGender(el, v) {
            document.getElementById('edit-gender').value = v;
            document.querySelectorAll('.visual-gender').forEach(l => l.classList.remove('selected'));
            if (el) el.classList.add('selected');
            else {
                const found = Array.from(document.querySelectorAll('.visual-gender')).find(e => e.innerText.includes(v));
                if (found) found.classList.add('selected');
            }
        }

        // ============================================
        // LIBRARY & FAVORITES LOGIC
        // ============================================
        let currentLibTab = 'workouts';

        function openLibrary() {
            document.getElementById('library-sidebar').classList.remove('translate-x-full');
            loadFavorites();
        }

        function closeLibrary() {
            document.getElementById('library-sidebar').classList.add('translate-x-full');
        }

        function switchLibTab(tab) {
            currentLibTab = tab;
            // Update UI
            document.getElementById('tab-workouts').className = tab === 'workouts'
                ? "flex-1 py-2 text-sm font-bold rounded-lg bg-white dark:bg-slate-800 text-brand-600 shadow-sm transition-all"
                : "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all";

            document.getElementById('tab-nutrition').className = tab === 'nutrition'
                ? "flex-1 py-2 text-sm font-bold rounded-lg bg-white dark:bg-slate-800 text-brand-600 shadow-sm transition-all"
                : "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all";

            loadFavorites();
        }

        async function loadFavorites() {
            if (!currentUser) return;
            const container = document.getElementById('library-content');

            try {
                const res = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/favorites?user_id=${currentUser.uid}`);
                const data = await res.json();

                if (data.success) {
                    renderLibraryItems(data.favorites);
                }
            } catch (e) {
                console.error("Load Lib Error:", e);
                container.innerHTML = "<div class='text-red-500 text-center'>Failed to load vault.</div>";
            }
        }

        function renderLibraryItems(favs) {
            const container = document.getElementById('library-content');
            container.innerHTML = "";

            const items = currentLibTab === 'workouts' ? favs.exercises : favs.nutrition;

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 mt-10">
                        <i class="far fa-folder-open text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm">No items saved yet.<br>Click the <i class="fas fa-star text-amber-500"></i> on any recommendation!</p>
                    </div>`;
                return;
            }

            items.forEach((item, index) => {
                let card = "";
                if (currentLibTab === 'workouts') {
                    const itemJson = JSON.stringify(item).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    card = `
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700 relative group hover:border-brand-200 dark:hover:border-brand-600 transition-all">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <div class="font-bold text-slate-800 dark:text-slate-200">${item.Title}</div>
                                <div class="text-xs text-slate-500 uppercase tracking-wide mt-1">${item.Bodypart} • ${item.protocol || '3x10'}</div>
                            </div>
                            <div class="text-amber-500"><i class="fas fa-star"></i></div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="explainVaultExercise('${item.Title}')" class="flex-1 py-2 px-3 bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 rounded-lg text-xs font-bold hover:bg-brand-100 dark:hover:bg-brand-900/50 transition-colors">
                                <i class="fas fa-play-circle mr-1"></i> Learn How
                            </button>
                        </div>
                    </div>`;
                } else {
                    // Nutrition format
                    const p = item.Protein || 0;
                    const c = item.Carbs || 0;
                    const f = item.Fat || 0;
                    const cal = item.Calories || 0;

                    card = `
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700 relative group hover:border-emerald-200 dark:hover:border-emerald-600 transition-all">
                        <div class="font-bold text-slate-800 dark:text-slate-200 pr-6">${item.Name}</div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mt-1 mb-2">${item.Meal_Type} • ${cal} kcal</div>
                        
                        <!-- Mini Macro Bar -->
                        <div class="flex h-1.5 w-full rounded-full overflow-hidden bg-slate-200 dark:bg-slate-700">
                            <div class="bg-rose-500" style="width: ${p}%"></div>
                            <div class="bg-amber-500" style="width: ${c}%"></div>
                            <div class="bg-blue-500" style="width: ${f}%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-400 mt-1 mb-3">
                            <span>P: ${p}g</span><span>C: ${c}g</span><span>F: ${f}g</span>
                        </div>
                        <button onclick="getRecipe('${item.Name.replace(/'/g, "\\'")}')" class="w-full py-2 px-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-lg text-xs font-bold hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-colors">
                            <i class="fas fa-utensils mr-1"></i> View Recipe
                        </button>
                        <div class="absolute right-3 top-3 text-amber-500"><i class="fas fa-star"></i></div>
                    </div>`;
                }
                container.innerHTML += card;
            });
        }

        // Explain a favorited exercise with YouTube link
        async function explainVaultExercise(exerciseName) {
            closeLibrary();
            document.getElementById('welcome-screen').classList.add('hidden');

            addMessage(`Tell me how to do ${exerciseName}`, 'user');
            showTyping();

            try {
                const res = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/get-recommendation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.uid,
                        message: `Explain the proper form for ${exerciseName} and provide a YouTube tutorial link`,
                        session: backendSession
                    })
                });
                const data = await res.json();

                removeTyping();
                if (data.session) backendSession = data.session;

                if (data.reply) {
                    addMessage(data.reply, 'ai');
                }
            } catch (error) {
                removeTyping();
                addMessage("Sorry, I couldn't explain that exercise right now.", 'ai');
            }
        }


        async function toggleFavorite(el, itemData, type) {
            if (!currentUser) return;
            // Optimistic UI
            const icon = el.querySelector('i');
            icon.classList.remove('far'); // outlined
            icon.classList.add('fas', 'text-amber-500'); // filled

            try {
                await fetch(`${window.API_CONFIG?.BASE_URL || ''}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.uid,
                        item_data: itemData,
                        rating: 'good',
                        item_type: type
                    })
                });
                // Reload library only if open
                if (!document.getElementById('library-sidebar').classList.contains('translate-x-full')) {
                    loadFavorites();
                }
            } catch (e) { console.error(e); }
        }

        async function hideItem(el, itemData, type) {
            if (!currentUser) return;
            // Visual removal
            const card = el.closest('.group');
            card.style.opacity = '0.5';

            try {
                await fetch(`${window.API_CONFIG?.BASE_URL || ''}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.uid,
                        item_data: itemData,
                        rating: 'bad',
                        item_type: type
                    })
                });
                card.innerHTML = "<div class='p-4 text-center text-xs text-slate-400'>Item hidden & added to ignore list.</div>";
            } catch (e) { console.error(e); }
        }

        function calculateLiveBMI() {
            const h = parseFloat(document.getElementById('edit-height').value) / 100;
            const w = parseFloat(document.getElementById('edit-weight').value);
            const display = document.getElementById('bmi-display-area');
            const score = document.getElementById('live-bmi-score');
            const badge = document.getElementById('live-bmi-badge');

            if (h > 0 && w > 0) {
                display.classList.remove('hidden');
                const bmi = (w / (h * h)).toFixed(1);
                score.innerText = bmi;

                // Categories
                if (bmi < 18.5) { badge.innerText = "Underweight"; badge.className = "px-3 py-1 rounded-lg text-sm font-bold bg-blue-100 text-blue-700"; }
                else if (bmi < 25) { badge.innerText = "Normal"; badge.className = "px-3 py-1 rounded-lg text-sm font-bold bg-green-100 text-green-700"; }
                else if (bmi < 30) { badge.innerText = "Overweight"; badge.className = "px-3 py-1 rounded-lg text-sm font-bold bg-orange-100 text-orange-700"; }
                else { badge.innerText = "Obese"; badge.className = "px-3 py-1 rounded-lg text-sm font-bold bg-red-100 text-red-700"; }
            } else {
                display.classList.add('hidden');
            }
        }

        // Profile photo handling
        let selectedPhotoBase64 = null;

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (max 500KB)
            if (file.size > 500 * 1024) {
                alert('Image too large. Please select an image under 500KB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const base64 = e.target.result;
                selectedPhotoBase64 = base64;

                // Update preview
                const imgEl = document.getElementById('profile-photo-img');
                const initialEl = document.getElementById('profile-photo-initial');
                imgEl.src = base64;
                imgEl.classList.remove('hidden');
                initialEl.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function initProfilePhotoPreview() {
            const imgEl = document.getElementById('profile-photo-img');
            const initialEl = document.getElementById('profile-photo-initial');

            if (userProfileCache.photo_url) {
                imgEl.src = userProfileCache.photo_url;
                imgEl.classList.remove('hidden');
                initialEl.classList.add('hidden');
            } else {
                const name = userProfileCache.name || 'U';
                initialEl.textContent = name.charAt(0).toUpperCase();
                initialEl.classList.remove('hidden');
                imgEl.classList.add('hidden');
            }
            selectedPhotoBase64 = null; // Reset
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const updates = {
                name: document.getElementById('edit-name').value,
                age: document.getElementById('edit-age').value,
                gender: document.getElementById('edit-gender').value,
                weight: document.getElementById('edit-weight').value,
                height: document.getElementById('edit-height').value,
                goal: document.getElementById('edit-goal').value,
                fitness_level: document.getElementById('edit-level').value,
                medical_conditions: document.getElementById('edit-conditions').value
            };

            // Include photo if selected
            if (selectedPhotoBase64) {
                updates.photo_url = selectedPhotoBase64;
            }

            await fetch(`${window.API_CONFIG?.BASE_URL || ''}/update-user-profile`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: currentUser.uid, updates }) });
            closeProfileModal();
            await loadUserProfile(currentUser.uid);
        }


        // Onboarding (Updated Flow)
        function startOnboarding() { isOnboarding = true; onboardingStep = 0; document.getElementById('welcome-screen').classList.add('hidden'); addMessage("Hello! 👋 I'm Atlas. Ready to get started?", 'ai'); }

        async function handleOnboardingInput(text) {
            if (onboardingStep === 0) { onboardingStep = 1; addMessage("First, what is your Age?", 'ai'); }
            else if (onboardingStep === 1) { onboardingData.age = parseInt(text); onboardingStep = 2; addMessage(`Gender?<br><div class="flex gap-2 mt-2"><button onclick="finishGenderStep('Male')" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold transition-colors">Male</button><button onclick="finishGenderStep('Female')" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold transition-colors">Female</button></div>`, 'ai'); }
            else if (onboardingStep === 3) { onboardingData.height = parseFloat(text); onboardingStep = 4; addMessage("Weight (kg)?", 'ai'); }
            else if (onboardingStep === 4) { onboardingData.weight = parseFloat(text); onboardingStep = 5; addMessage(`Experience?<br><div class="flex gap-2 mt-2"><button onclick="finishLevelStep('Beginner')" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold transition-colors">Beginner</button><button onclick="finishLevelStep('Intermediate')" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold transition-colors">Intermediate</button></div>`, 'ai'); }
            // Step 7: Medical Conditions
            else if (onboardingStep === 7) {
                onboardingData.medical_conditions = text;
                finishOnboardingFinal();
            }
        }

        function finishGenderStep(g) { onboardingData.gender = g; addMessage(g, 'user'); onboardingStep = 3; addMessage("Height (cm)?", 'ai'); }

        function finishLevelStep(l) { onboardingData.fitness_level = l; addMessage(l, 'user'); onboardingStep = 6; addMessage(`Goal?<br><div class="flex flex-wrap gap-2 mt-2"><button onclick="finishGoalStep('Weight Loss')" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold transition-colors">Weight Loss</button><button onclick="finishGoalStep('Muscle Gain')" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold transition-colors">Muscle Gain</button><button onclick="finishGoalStep('Maintenance')" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold transition-colors">Maintenance</button></div>`, 'ai'); }

        function finishGoalStep(g) {
            onboardingData.goal = g;
            addMessage(g, 'user');
            onboardingStep = 7; // Go to Medical Step
            addMessage("Any medical conditions or injuries? (e.g., 'Knee pain', or type 'None')", 'ai');
        }

        async function finishOnboardingFinal() {
            addMessage(onboardingData.medical_conditions, 'user');
            await fetch(`${window.API_CONFIG?.BASE_URL || ''}/update-user-profile`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: currentUser.uid, updates: onboardingData }) });
            isOnboarding = false;
            await loadUserProfile(currentUser.uid);
            addMessage("Profile Ready! Let's get to work.", 'ai');
        }

        // Morning check-in feature
        async function performMorningCheckin(userId) {
            const now = new Date();
            const lastCheckin = localStorage.getItem(`lastCheckin_${userId}`);
            const lastCheckinDate = lastCheckin ? new Date(lastCheckin) : null;

            // Only check in once per day, in the morning
            if (lastCheckinDate && lastCheckinDate.toDateString() === now.toDateString()) {
                return;
            }

            if (now.getHours() >= 6 && now.getHours() <= 10) {
                const response = await fetch(`${window.API_CONFIG?.BASE_URL || ''}/morning-checkin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem(`lastCheckin_${userId}`, now.toISOString());

                    // Show personalized morning message
                    addMessage(data.message, 'ai');
                }
            }
        }
    </script>